PKGNAME=gcc-runtime
PKGSEC=devel
PKGDEP="glibc"
PKGDES="GNU Compiler Collection (runtime libraries only)"

# The following configuration:
#
# 1. Redirect libexec directory to /usr/lib;
# 2.  Use the new "cxx11/new" for libstdc++, available since GCC 5. The old
#     "gcc4-compatbile" ABI was used until Core 5.
# 3.  Enables linking to system Zlib;
# 4.  Sets our bug tracking URL;
# 5.  Enables release level checking;
# 6.  Enables GNU style C locales (you probably would not want to change this);
# 7.  Enables the use of __cxa_atexit rather than atexit for C++;
# 8.  Enables -fpie and -fPIE by default for hardening;
# 9.  Enables -fstack-protector-strong by default for hardening;
# 10. Enables support for GNU indirect function;
# 11. Enables GNU unique object for C++;
# 12. Enables libiberty (static library) installation;
# 13. Enables Dual ABI (C++98 / C++11) support;
# 14. Enables linker build ID;
# 15. Enables LTO support;
# 16. Enables plugin support;
# 17. Enables POSIX style threading;
# 18. Disables libssp linking (not needed, provided by Glibc);
# 19. Disables pre-compiled headers for libstdcxx;
# 20. Disables internal libunwind support for exception detection;
# 21. Disables multilib support
#     (you may remove "--disable-multilib" to enable the support for it, however
#     you will need a copy of GCC with multilib support to build);
#     a. AOSC OS uses subsystems to provide binary support for foreign architectures.
# 22. Disables warning as errors;
#
# For language supports:
#
# 23. Enables support for C, C++, Fortran, "LTO", Go, ObjC, and ObjC++;
#     a. Mind here, Object C/C++ support is not enabled, we will provide that
#        in the "llvm" package as they provide a higher quality support for them;
#     b. Fortran is needed for many mathematical packages, as well as some audio/
#        video codecs, remove support for fortran if you know what you are doing;
#     c. "LTO" is not really a language, but it enables GCC to use LTO flags, and
#        thus provide respective optimizations later;
#     d. ObjC and ObjC++ is mainly used by the libobjc2 library and what is
#        dependent on it;
#     e. Go is not built on riscv64 and powerpc platforms because of
#        incompatibility;
#
# For architectures other than mips64{,r2}el:
#
# 24. Enables GNU style linker hash.
#
# Other platform specific configurations are specified below.

AUTOTOOLS_AFTER="--libexecdir=/usr/lib \

                 --with-default-libstdcxx-abi=new \
                 --with-system-zlib \
                 --with-bugurl=https://github.com/AOSC-Dev/aosc-os-core

                 --enable-checking=release \
                 --enable-clocale=gnu \
                 --enable-__cxa_atexit \
                 --enable-default-pie \
                 --enable-default-ssp \
                 --enable-gnu-indirect-function \
                 --enable-gnu-unique-object \
                 --enable-install-libiberty \
                 --enable-libstdcxx-dual-abi \
                 --enable-linker-build-id \
                 --enable-lto \
                 --enable-plugin \
                 --enable-threads=posix \

                 --disable-libssp \
                 --disable-libstdcxx-pch \
                 --disable-libunwind-exceptions \
                 --disable-multilib \
                 --disable-werror"

if [[ "${CROSS:-$ARCH}" != "riscv64" && "${CROSS:-$ARCH}" != "powerpc" ]]; then
    AUTOTOOLS_AFTER+=" --enable-languages=c,c++,fortran,lto,go,objc,obj-c++"
else
    # When libFFI is not available on an architecture, Go is not available.
    AUTOTOOLS_AFTER+=" --enable-languages=c,c++,fortran,lto,objc,obj-c++"
fi

# Cross.
if [[ "${CROSS:-$ARCH}" = *cross* ]]; then
    AUTOTOOLS_AFTER+=" --host=${ARCH_TARGET[$ARCH]} \
                       --target=${ARCH_TARGET[$ARCH]}"
fi

# MIPS is not yet happy with GNU hashing style.
# Q: Really?
# A: At least our MIPS-II (o32) still couldn't be built with GNU hash style.
#    It is an ABI incompatibility, not an emulation error...
if [[ "${CROSS:-$ARCH}" != mips32 ]]; then
    AUTOTOOLS_AFTER+=" --with-linker-hash-style=gnu"
fi

# ARM and AArch64 specific.
if [[ "${CROSS:-$ARCH}" = arm* ]]; then
    AUTOTOOLS_AFTER+=" --disable-altivec --disable-fixed-point"
fi

# ARMEL had a weird triplet.
if [[ "${CROSS:-$ARCH}" = "armel" ]]; then
    AUTOTOOLS_AFTER+=" --with-arch=armv7-a --with-float=hard \
                       --with-fpu=neon"
fi

# AArch64 specific architectural config.
if [[ "${CROSS:-$ARCH}" = "arm64" ]]; then
    AUTOTOOLS_AFTER+=" --with-arch=armv8-a --enable-fix-cortex-a53-835769 --enable-fix-cortex-a53-843419"
fi

# PowerPC specific.
if [[ "${CROSS:-$ARCH}" = "powerpc" ]]; then
    AUTOTOOLS_AFTER+=" --with-tune=G4 \
                       --with-long-double-128 --enable-secureplt"
fi

# PowerPC64 specific.
if [[ "${CROSS:-$ARCH}" = "ppc64" ]]; then
    AUTOTOOLS_AFTER+=" --with-cpu=620 --with-tune=G5 \
                       --with-long-double-128 --enable-secureplt"
fi

# MIPS64EL specific.
if [[ "${CROSS:-$ARCH}" = "mips64el" ]]; then
    AUTOTOOLS_AFTER+=" --with-abi=64 --with-arch=mips64r2 \
                       --with-tune=loongson3a"
fi

# RISC-V specific
if [[ "${CROSS:-$ARCH}" = riscv* ]]; then
    AUTOTOOLS_AFTER+=" --without-libffi"
fi

ABMK="profiledbootstrap"
AB_FLAGS_SPECS=0
AB_FLAGS_O3=1
NOLTO=1

RECONF=0

PKGBREAK="gcc<=5.2.0-1"
ABRPMAUTOPROVONLY=yes
